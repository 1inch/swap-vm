---
globs: test/**/*
alwaysApply: false
---

# SwapVM Test Guidelines

## File Naming
- Unit tests: `<Feature>.t.sol`
- Aqua tests: `<Feature>Aqua.t.sol`
- Base invariant tests: `test/invariants/<Feature>Invariants.t.sol`
- Fee invariant tests: `test/invariants/<Feature>FeesInvariants.t.sol`
- Scenario tests: `test/invariants/<swap_type>/<Scenario>.t.sol`
- Gas benchmarks: `test/gas/<Feature>Gas.t.sol`

## Directory Structure
- `test/base/` - Base test classes
  - `AquaSwapVMTest.sol` - Main test base for Aqua strategies
  - `AquaStrategyBuilders.sol` - Strategy building helpers
  - `TestConstants.sol` - Common test constants
- `test/helpers/` - Helper contracts
  - `AquaSwapVMHelper.sol` - Aqua mode swap helper
  - `DirectSwapVMHelper.sol` - Direct mode swap helper
  - `DirectModeTaker.sol` - Taker for direct mode tests
- `test/mocks/` - Mock contracts
  - `MockTaker.sol`, `MockTakerBrokenCallback.sol`, `MockTakerFirstTransfer.sol`
  - `MockMakerHooks.sol` - Maker hooks mock
  - `TokenMockDecimals.sol` - Token with configurable decimals
  - `WETHMock.sol` - WETH mock
- `test/utils/` - Utilities
  - `Dynamic.sol` - Dynamic array builder
  - `ProgramBuilder.sol` - Bytecode program builder
  - `FormatLib.sol` - Formatting utilities
  - `OrderHasher.sol` - Order hash utilities
- `test/invariants/` - Invariant tests
  - `CoreInvariants.t.sol` - Base invariant assertions
  - `RoundingInvariants.sol` - Rounding exploit protection library
  - `ExactInOutSymmetry.t.sol` - Symmetry assertion library
  - `ExampleInvariantUsage.t.sol` - Usage examples
  - `XYCFeesInvariants.t.sol` - XYC with fees base
  - `PeggedSwapInvariants.t.sol`, `PeggedFeesInvariants.t.sol`
  - `xyc/` - XYC scenario tests (BalancedPoolEdgeFees, DustAmounts, HugeLiquidity, ImbalancedPool*, LargeAmounts, SmallAmounts, TinyLiquidity)
  - `pegged/` - Pegged scenario tests (BalancedCurve, MostlyCurved, PureSquareRoot, VeryLinear, LargeDifferentDecimals, VeryImbalancedDifferentDecimals, ...)
- `test/gas/` - Gas benchmarks
  - `AMMGas.t.sol`, `LimitSwapGas.t.sol`

## Inheritance
- **Aqua tests**: Inherit from `AquaSwapVMTest` (provides swapVM, taker, tokens, helpers)
- **Direct tests**: Inherit from `Test` + `OpcodesDebug`
- **Invariant tests**: Inherit from `CoreInvariants` + implement `_executeSwap()`
- **Scenario tests**: Inherit from base invariant test (e.g., `XYCFeesInvariants`) + override config in setUp()

## Key Structs
- `MakerSetup` - Order configuration (balances, fees, swapType)
- `SwapProgram` - Swap parameters (amount, taker, tokens, zeroForOne, isExactIn)
- `InvariantConfig` - Invariant test configuration (tolerances, skip flags, test amounts)
- `FeeConfig` - Fee configuration (flat, progressive, protocol fees)

## Test Naming
Pattern: `test_<Feature>[_<FeeType>]`
- `test_XYC` - Basic invariants
- `test_XYCFlatFeeIn` - With flat fee on input
- `test_XYCProgressiveFeeOut` - With progressive fee on output
- `test_XYCProtocolFee` - With protocol fee
- `test_XYCMultipleFees` - Combined fee types

## Scenario Tests
Tests in `test/invariants/xyc/` and `test/invariants/pegged/` cover:
- Balanced vs imbalanced pool ratios
- Edge case fees (extreme high/low)
- Dust, small, medium, large amounts
- Tiny vs huge liquidity
- Different token decimals

## Key Helpers
**From AquaSwapVMTest**: createStrategy, shipStrategy, swap, quote, mint helpers, balance queries

**From CoreInvariants**: assertAllInvariants, assertSymmetryInvariant, assertAdditivityInvariant, assertMonotonicityInvariant, assertQuoteSwapConsistencyInvariant, assertRoundingFavorsMakerInvariant

**From RoundingInvariants**: assertNoAccumulationExploit, assertNoRoundTripProfit

**From ExactInOutSymmetry**: assertSymmetry, assertSymmetryBatch

## Patterns
- Use `vm.snapshot()` / `vm.revertTo()` for state isolation
- Use `dynamic([...])` helper for building arrays
- Use `assertApproxEqAbs` for wei tolerance, `assertApproxEqRel` for percentage
- Override storage variables in setUp() for scenario configuration

## Security Test Categories
1. **Round-Trip**: No arbitrage profit from A→B→A
2. **Pool Drain**: K product increases after swaps
3. **Sandwich**: Protected against sandwich attacks
4. **Split Swap**: Single swap ≥ split swaps (additivity)
5. **Overflow**: Large inputs gracefully revert
6. **Boundaries**: Smooth transitions at mathematical boundaries
7. **Monotonicity**: Larger trades get equal or worse prices
8. **Symmetry**: exactIn(X)→Y ↔ exactOut(Y)→X
9. **Quote/Swap Consistency**: Identical amounts
10. **Rounding Favors Maker**: Small trades don't beat spot

## Skip Flags
- `skipAdditivity` - Progressive fees, limit orders
- `skipMonotonicity` - Flat-rate orders, dust amounts
- `skipSpotPrice` - Complex fee structures
- `skipSymmetry` - Asymmetric fee structures

## Tolerance Guidelines
| Scenario | symmetryTolerance | additivityTolerance | roundingToleranceBps |
|----------|-------------------|---------------------|----------------------|
| Standard | 2 wei | 0 | 100 (1%) |
| Imbalanced pools | 10+ wei | 0 | 200+ |
| High fees | 2 wei | 1 wei | 500+ |
| Protocol fees | 2 wei | 1 wei | 100 |
