---
globs: test/**/*
alwaysApply: false
---

# SwapVM Test Guidelines

## File Naming
- Unit tests: `<Feature>.t.sol`
- Aqua tests: `<Feature>Aqua.t.sol`
- Invariant tests: `test/invariants/<Feature>Invariants.t.sol`
- Gas benchmarks: `test/gas/<Feature>Gas.t.sol`

## Directory Structure
- `test/base/` - Base test classes (`AquaSwapVMTest`, `AquaStrategyBuilders`, `TestConstants`)
- `test/helpers/` - Helper contracts (`AquaSwapVMHelper`, `DirectSwapVMHelper`)
- `test/mocks/` - Mock contracts (`MockTaker`, etc.)
- `test/utils/` - Utilities (`Dynamic.sol`, `ProgramBuilder.sol`)
- `test/invariants/` - Invariant test contracts

## Inheritance
- **Aqua tests**: Inherit from `AquaSwapVMTest` (provides swapVM, taker, tokens, helpers)
- **Direct tests**: Inherit from `Test` + `OpcodesDebug`
- **Invariant tests**: Inherit from `CoreInvariants` + implement `_executeSwap()`

## Key Structs
- `MakerSetup` - Order configuration (balances, fees, swapType)
- `SwapProgram` - Swap parameters (amount, taker, tokens, zeroForOne, isExactIn)
- `InvariantConfig` - Invariant test configuration (tolerances, skip flags)

## Test Naming
Pattern: `test_<Feature>_<Scenario>[_<Variation>]`
- `test_Aqua_XYC_ExactIn_BalancesCorrect`
- `test_Aqua_XYC_NoArbitrage_InThenOut`
- `test_gas_XYCSwap_swap_exactIn`

## Test Organization
Use section headers to group related tests:
- Balance Consistency Tests
- Arbitrage Protection Tests
- K Invariant Tests
- Economic Properties Tests
- Overflow Protection Tests

## Key Helpers (from AquaSwapVMTest)
- `createStrategy(MakerSetup)` - Build order from config
- `shipStrategy(order, tokenIn, tokenOut, balanceIn, balanceOut)` - Deploy to Aqua
- `swap(SwapProgram, order)` - Execute swap
- `quote(SwapProgram, order)` - Get quote
- `mintTokenInToTaker(SwapProgram)` - Mint input tokens
- `mintTokenOutToMaker(SwapProgram, amount)` - Mint output tokens
- `getAquaBalances(strategyHash)` - Query Aqua balances
- `getTakerBalances(taker)` - Query taker balances

## Constants (from TestConstants)
`ONE`, `INITIAL_BALANCE_A/B`, `DUST_AMOUNT`, `TINY_AMOUNT`, `SMALL_AMOUNT`, `MEDIUM_AMOUNT`, `LARGE_AMOUNT`, `MAX_REASONABLE_AMOUNT`, `OVERFLOW_AMOUNT`

## Patterns
- Use `vm.snapshot()` / `vm.revertTo()` for state isolation in comparisons
- Use `dynamic([...])` helper for building arrays
- Use `assertApproxEqAbs` for rounding tolerance (1 wei)
- Use `assertApproxEqRel` for percentage tolerance (1e15 = 0.1%)

## Test Categories Checklist
1. Balance consistency after swaps
2. Arbitrage protection (round-trip should not profit)
3. K invariant (balanceA × balanceB should not decrease)
4. Effective rate ≤ spot price
5. Rounding favors protocol
6. Single swap beats split swaps
7. No rounding accumulation exploits
8. Overflow protection (graceful reverts)
